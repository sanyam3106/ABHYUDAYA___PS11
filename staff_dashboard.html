<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Dashboard - HostelEase</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>HostelEase</h2>
                <span class="badge" style="background-color: #e2e8f0; color: #475569;">STAFF</span>
            </div>
            <div class="user-info">
                <p><strong>Staff Member</strong></p>
                <p>Maintenance Staff</p>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item"><a href="#tasks" class="menu-link active">My Tasks</a></li>
                <li class="menu-item"><a href="login.html" class="menu-link" style="color: var(--danger);">Logout</a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Staff Dashboard</h1>
            </div>

            <!-- Assigned Tasks -->
            <section id="tasks" class="card">
                <h3>Assigned Maintenance Requests</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Issue Details</th>
                                <th>Location</th>
                                <th>Assigned Date</th>
                                <th>Current Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Tasks will be loaded from LocalStorage -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const complaints = JSON.parse(localStorage.getItem('hostel_complaints')) || [];
            const tbody = document.querySelector('tbody');

            // Filter for tasks that are Assigned or In Progress (simulating this staff member's queue)
            // For demo purposes, we'll just show ALL assigned/in-progress tasks to make it easy to test.
            const myTasks = complaints.filter(c => c.status === 'Assigned' || c.status === 'In Progress');

            if (myTasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem; color: #6b7280;">No pending tasks assigned to you.</td></tr>';
            } else {
                tbody.innerHTML = '';
                myTasks.forEach(task => {
                    const row = document.createElement('tr');

                    let actionBtn = '';
                    if (task.status === 'Assigned') {
                        actionBtn = `<button class="btn" onclick="updateStatus(this, ${task.id}, 'In Progress')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; width: auto; background-color: var(--warning);">Start Work</button>`;
                    } else if (task.status === 'In Progress') {
                        actionBtn = `<button class="btn" onclick="updateStatus(this, ${task.id}, 'Resolved')" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; width: auto; background-color: var(--success);">Mark Resolved</button>`;
                    }

                    const badgeClass = task.priority === 'High' ? 'badge-high' : (task.priority === 'Medium' ? 'badge-medium' : 'badge-low');

                    const mediaHint = task.media ? `<br><small style="color:var(--primary-color); cursor:pointer;" onclick="viewMedia(${task.id})">ðŸ“Ž View Media</small>` : '';

                    row.innerHTML = `
                        <td><span class="badge ${badgeClass}">${task.priority}</span></td>
                        <td><strong>${task.title}</strong>${mediaHint}<br><span style="font-size: 0.85rem; color: #4b5563;">${task.category}</span></td>
                        <td>Hostel A<br>Room: ${task.room || '101'}</td>
                        <td>${task.date}</td>
                        <td><span class="badge status-${task.status.toLowerCase().replace(' ', '')}">${task.status}</span></td>
                        <td>${actionBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        });

        window.updateStatus = function (btn, id, newStatus) {
            // Prompt for details
            let defaultText = newStatus === 'In Progress' ? 'Work started.' : 'Issue resolved successfully.';
            const remark = prompt(`Add a remark for the "Task ${newStatus}" update:`, defaultText);

            let complaints = JSON.parse(localStorage.getItem('hostel_complaints')) || [];
            const index = complaints.findIndex(c => c.id === id);

            if (index !== -1) {
                complaints[index].status = newStatus;

                // Add to tracking history
                if (!complaints[index].tracking) complaints[index].tracking = [];
                complaints[index].tracking.push({
                    role: 'Staff',
                    text: remark || defaultText,
                    date: new Date().toLocaleString()
                });

                localStorage.setItem('hostel_complaints', JSON.stringify(complaints));

                // Refresh the list to reflect changes (simplest way for prototype)
                window.location.reload();
            }
        };

        // View Media & Overlay Logic (Shared)
        window.viewMedia = function (id) {
            const complaints = JSON.parse(localStorage.getItem('hostel_complaints')) || [];
            const complaint = complaints.find(c => c.id === id);
            if (!complaint || !complaint.media) return;

            let mediaHtml = '';
            if (complaint.mediaType && complaint.mediaType.startsWith('video/')) {
                mediaHtml = `<video controls style="max-width: 100%; border-radius: 0.5rem; margin-top: 1rem;"><source src="${complaint.media}" type="${complaint.mediaType}">Your browser does not support the video tag.</video>`;
            } else {
                mediaHtml = `<img src="${complaint.media}" style="max-width: 100%; border-radius: 0.5rem; margin-top: 1rem;" alt="Complaint Media">`;
            }

            const html = `
                <h3>Media Attachment: #${id}</h3>
                ${mediaHtml}
                <div style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                    <strong>Description:</strong><br>${complaint.description || 'No description provided.'}
                </div>
                <button class="btn" style="margin-top: 1rem; background: #ccc;" onclick="closeOverlay()">Close</button>
            `;
            showOverlay(html);
        };

        function showOverlay(content) {
            let overlay = document.getElementById('custom-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'custom-overlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';
                document.body.appendChild(overlay);
            }
            overlay.innerHTML = `<div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 400px; width: 90%; position: relative;">${content}</div>`;
            overlay.style.display = 'flex';
        }

        window.closeOverlay = function () {
            const overlay = document.getElementById('custom-overlay');
            if (overlay) overlay.style.display = 'none';
        }
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warden Admin Dashboard - HostelEase</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>HostelEase</h2>
                <span class="badge badge-high">ADMIN</span>
            </div>
            <div class="user-info">
                <p><strong>Welcome, Warden Admin</strong></p>
                <p>Warden Panel</p>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item"><a href="#overview" class="menu-link active">Overview</a></li>
                <li class="menu-item"><a href="#complaints" class="menu-link">Manage Complaints</a></li>
                <li class="menu-item"><a href="login.html" class="menu-link" style="color: var(--danger);">Logout</a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Admin Dashboard</h1>
            </div>

            <!-- Stats Overview -->
            <section id="overview" class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">42</div>
                    <div class="stat-label">Total Complaints</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--warning);">
                    <div class="stat-value">5</div>
                    <div class="stat-label">Pending / Submitted</div>
                </div>
                <div class="stat-card" style="border-left-color: var(--success);">
                    <div class="stat-value">37</div>
                    <div class="stat-label">Resolved / Closed</div>
                </div>
            </section>

            <!-- Complaints Management -->
            <section id="complaints" class="card">
                <h3>All Complaints (Priority View)</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Priority</th>
                                <th>Student</th>
                                <th>Room</th>
                                <th>Complaint</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Action / Feedback</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Complaints loaded from LocalStorage -->
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const complaints = JSON.parse(localStorage.getItem('hostel_complaints')) || [];
            const tbody = document.querySelector('tbody');

            if (complaints.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 2rem; color: #6b7280;">No complaints found. Submit one from the Student Dashboard!</td></tr>';
            } else {
                tbody.innerHTML = ''; // Clear loading/placeholder
                complaints.slice().reverse().forEach(c => { // Show newest first
                    const row = document.createElement('tr');

                    // Determine Button State & Feedback Display
                    let actionBtn = '';
                    if (c.status === 'Submitted') {
                        actionBtn = `<button class="btn assign-btn" onclick="handleAssign(this, ${c.id})" style="padding: 0.25rem 0.5rem; width: auto; font-size: 0.8rem;">Assign</button>`;
                    } else if (c.status === 'Resolved' && c.feedback) {
                        actionBtn = `<span title="${c.feedback.comment}" style="cursor: help;">â˜… ${c.feedback.rating}/5</span>`;
                    } else {
                        actionBtn = `<button disabled style="opacity: 0.5; padding: 0.25rem 0.5rem; min-width: 60px; font-size: 0.8rem;">${c.status}</button>`;
                    }

                    let assignedTo = c.status === 'Submitted' ? '<span style="color:#9ca3af;">--</span>' : 'Staff Member';

                    // Priority Badge Color
                    let badgeClass = c.priority === 'High' ? 'badge-high' : (c.priority === 'Medium' ? 'badge-medium' : 'badge-low');

                    const mediaHint = c.media ? `<br><small style="color:var(--primary-color); cursor:pointer;" onclick="viewMedia(${c.id})">ðŸ“Ž View Media</small>` : '';

                    row.innerHTML = `
                        <td><span class="badge ${badgeClass}">${c.priority}</span></td>
                        <td>${c.student}<div style="font-size: 0.75rem; color: #6b7280;">ID: ${c.id}</div></td>
                        <td>${c.room}</td>
                        <td><strong>${c.title}</strong>${mediaHint}<br><span style="font-size: 0.85rem; color: #4b5563;">${c.category}</span></td>
                        <td>${c.date}</td>
                        <td><span class="badge status-${c.status.toLowerCase()}">${c.status}</span></td>
                        <td>${assignedTo}</td>
                        <td>${actionBtn}</td>
                     `;
                    tbody.appendChild(row);
                });
            }
        });

        // Global function for Assign button
        window.handleAssign = function (btn, id) {
            const row = btn.closest('tr');
            // Update UI
            row.cells[5].innerHTML = '<span class="badge status-assigned">Assigned</span>';
            row.cells[6].textContent = 'Staff Member';
            btn.textContent = 'Done';
            btn.disabled = true;
            btn.style.background = '#ccc';
            btn.style.cursor = 'default';

            // Update LocalStorage
            let complaints = JSON.parse(localStorage.getItem('hostel_complaints')) || [];
            const index = complaints.findIndex(x => x.id === id);
            if (index !== -1) {
                // Prompt for Tracking Remark
                const remark = prompt("Add a tracking note for the student (optional):", "Staff assigned to check the issue.");

                complaints[index].status = 'Assigned';

                // Add to tracking history
                if (!complaints[index].tracking) complaints[index].tracking = [];
                complaints[index].tracking.push({
                    role: 'Warden',
                    text: remark || 'Staff assigned.',
                    date: new Date().toLocaleString()
                });

                localStorage.setItem('hostel_complaints', JSON.stringify(complaints));

                // Update Badge in UI immediately to reflect change
                const statusBadge = row.querySelector('.status-' + complaints[index].status.toLowerCase()) || row.querySelector('.badge');
                if (statusBadge) {
                    statusBadge.className = 'badge status-assigned';
                    statusBadge.textContent = 'Assigned';
                }
            }
        }

        // View Media & Overlay Logic (Shared)
        window.viewMedia = function (id) {
            const complaints = JSON.parse(localStorage.getItem('hostel_complaints')) || [];
            const complaint = complaints.find(c => c.id === id);
            if (!complaint || !complaint.media) return;

            let mediaHtml = '';
            if (complaint.mediaType && complaint.mediaType.startsWith('video/')) {
                mediaHtml = `<video controls style="max-width: 100%; border-radius: 0.5rem; margin-top: 1rem;"><source src="${complaint.media}" type="${complaint.mediaType}">Your browser does not support the video tag.</video>`;
            } else {
                mediaHtml = `<img src="${complaint.media}" style="max-width: 100%; border-radius: 0.5rem; margin-top: 1rem;" alt="Complaint Media">`;
            }

            const html = `
                <h3>Media Attachment: #${id}</h3>
                ${mediaHtml}
                <div style="margin-top: 1rem; color: var(--text-light); font-size: 0.9rem;">
                    <strong>Description:</strong><br>${complaint.description || 'No description provided.'}
                </div>
                <button class="btn" style="margin-top: 1rem; background: #ccc;" onclick="closeOverlay()">Close</button>
            `;
            showOverlay(html);
        };

        function showOverlay(content) {
            let overlay = document.getElementById('custom-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'custom-overlay';
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';
                document.body.appendChild(overlay);
            }
            overlay.innerHTML = `<div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 400px; width: 90%; position: relative;">${content}</div>`;
            overlay.style.display = 'flex';
        }

        window.closeOverlay = function () {
            const overlay = document.getElementById('custom-overlay');
            if (overlay) overlay.style.display = 'none';
        }
    </script>
</body>

</html>